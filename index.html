<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Atelier de Potions Magiques</title>
  <style>
    :root{--bg:#1a0f1f;--card:#24122b;--accent:#9b59b6;--muted:#a29fb0}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#0d0511 0%,#1a0f1f 100%);color:#f0eaf8}
    .wrap{max-width:1000px;margin:24px auto;padding:18px}
    header{display:flex;align-items:center;gap:12px;flex-wrap:wrap}
    h1{margin:0;font-size:22px}
    .board{display:grid;grid-template-columns:260px 1fr 260px;gap:14px;margin-top:18px}
    .panel{background:linear-gradient(180deg,var(--card),#13091a);border-radius:12px;padding:12px;box-shadow:0 6px 18px rgba(0,0,0,.6)}

    /* Ingr√©dients */
    .bottles{display:grid;grid-template-columns:1fr;gap:10px}
    .bottle{display:flex;align-items:center;gap:10px;padding:8px;border-radius:8px;background:rgba(255,255,255,0.03);cursor:pointer;transition:transform .12s}
    .bottle:hover{transform:translateY(-4px)}
    .bottle .cap{width:40px;height:40px;border-radius:6px;background:#0f1724;display:flex;align-items:center;justify-content:center;font-weight:700}
    .bottle .meta{flex:1}
    .bottle .meta small{display:block;color:var(--muted)}

    /* Chaudron */
    .bar-view{display:flex;flex-direction:column;align-items:center;gap:12px;padding:18px}
    .stage{width:100%;max-width:520px;height:260px;border-radius:14px;background:linear-gradient(180deg,#12091b,#200d2b);display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
    .glass{width:180px;height:180px;border:6px solid rgba(255,255,255,0.08);border-radius:50%;background:rgba(255,255,255,0.02);position:relative;overflow:hidden;display:flex;flex-direction:column-reverse;align-items:center}
    .liquid{width:100%;transition:height .35s ease, background .25s linear;display:block}
    .garnish{position:absolute;top:12px;right:12px;font-size:22px}
    .controls{display:flex;gap:10px;align-items:center;margin-top:8px;flex-wrap:wrap}
    button{flex:1;min-width:90px;background:transparent;border:1px solid rgba(255,255,255,0.06);color:inherit;padding:10px;border-radius:8px;cursor:pointer}
    .btn-primary{background:var(--accent);color:#fff;border:none}

    /* Recettes + Historique */
    .recipes{display:flex;flex-direction:column;gap:10px}
    .recipe{padding:10px;border-radius:8px;background:rgba(255,255,255,0.03)}
    .history{max-height:240px;overflow:auto;padding:8px;border-radius:8px;background:rgba(255,255,255,0.01)}

    /* R√©actions */
    .reaction{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%);font-size:20px;padding:8px 14px;border-radius:12px;background:rgba(0,0,0,0.6);opacity:0;transition:opacity .25s,transform .35s;text-align:center}
    .reaction.show{opacity:1;transform:translate(-50%,-90%)}

    /* Effet Noctambule */
    .noctambule{
      position:absolute;
      top:50%;left:50%;
      transform:translate(-50%,-50%);
      font-size:34px;
      font-weight:bold;
      color:#e0d4ff;
      text-shadow:0 0 15px #9b59b6,0 0 25px #fff;
      opacity:0;
      transition:opacity 0.8s ease;
      z-index:20;
    }
    .noctambule.show{opacity:1;}

    footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:900px){.board{grid-template-columns:1fr;}.panel{padding:10px}}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Atelier de Potions Magiques</h1>
      <div style="margin-left:auto;color:var(--muted)">Or : <span id="gold">0</span> üí∞</div>
    </header>

    <div class="board">
      <div class="panel">
        <h3>Ingr√©dients</h3>
        <div class="bottles" id="bottles"></div>
      </div>

      <div class="panel bar-view">
        <div class="stage">
          <div class="glass" id="glass">
            <div id="liquid" class="liquid" style="height:0%"></div>
          </div>
          <div class="garnish" id="garnish">‚ú®</div>
          <div class="reaction" id="reaction">OK</div>
          <div id="noctambule" class="noctambule">Noctambule üóùÔ∏è</div>
        </div>

        <div class="controls">
          <button id="undo">Annuler</button>
          <button id="clear">Vider</button>
          <button id="shake">Agiter</button>
          <button class="btn-primary" id="serve">Servir</button>
        </div>

        <div style="width:100%;display:flex;justify-content:space-between;margin-top:8px;flex-wrap:wrap">
          <div>Volume: <span id="volume">0</span>/100</div>
          <div>√âtat: <span id="state">Calme</span></div>
        </div>
      </div>

      <div class="panel">
        <h3>Recettes mystiques</h3>
        <div class="recipes" id="recipes"></div>
        <h3 style="margin-top:12px">Historique</h3>
        <div class="history" id="history"></div>
      </div>
    </div>

    <footer>Version potions magiques ‚ú® ‚Äî Optimis√© pour mobile</footer>
  </div>

  <script>
    /* --- ingr√©dients (ordre m√©lang√© + nouveaux) --- */
    const INGREDIENTS = [
      {id:'etoile', name:'Poussi√®re d‚Äô√©toile', abbr:'üåå', color:'#8e44ad'},
      {id:'herbes', name:'Herbes anciennes', abbr:'üåø', color:'#2ecc71'},
      {id:'fee', name:'Poussi√®re de f√©e', abbr:'‚ú®', color:'#f9d6ff'},
      {id:'rose', name:'P√©tale de rose noire', abbr:'üåπ', color:'#c0392b'},
      {id:'serpent', name:'Venin de serpent', abbr:'üêç', color:'#27ae60'},
      {id:'corbeau', name:'Plume de corbeau', abbr:'ü™∂', color:'#333333'},
      {id:'dragon', name:'Larme de dragon', abbr:'üêâ', color:'#d94b6a'},
      {id:'cristal', name:'Cristaux lunaires', abbr:'üíé', color:'#5dade2'},
      {id:'paon', name:'Plume de paon', abbr:'ü¶ö', color:'#1abc9c'},
      {id:'feu', name:'Souffle de feu', abbr:'üî•', color:'#e67e22'},
      {id:'glace', name:'√âclat de glace √©ternelle', abbr:'‚ùÑÔ∏è', color:'#85c1e9'}
    ];

    const RECIPES = [
      {name:'Potion de Vol', mix:{fee:40,herbes:30,cristal:30}, desc:'Vous donne des ailes pendant quelques instants.'},
      {name:'Potion de Grenouille', mix:{corbeau:50,herbes:50}, desc:'Transforme temporairement en batracien.'},
      {name:'Lueur Nocturne', mix:{cristal:50,fee:50}, desc:'Vous brillez doucement dans la nuit.'}
    ];

    let gold=0;
    const state = { pours:[], volume:0, shaken:false };

    const bottlesEl=document.getElementById('bottles');
    const recipesEl=document.getElementById('recipes');
    const historyEl=document.getElementById('history');
    const liquidEl=document.getElementById('liquid');
    const volumeEl=document.getElementById('volume');
    const stateEl=document.getElementById('state');
    const reactionEl=document.getElementById('reaction');
    const garnishEl=document.getElementById('garnish');
    const noctambuleEl=document.getElementById('noctambule');
    const goldEl=document.getElementById('gold');

    INGREDIENTS.forEach(ing=>{
      const div=document.createElement('div');
      div.className='bottle';
      div.dataset.id=ing.id;
      div.innerHTML=`<div class="cap" style="background:${ing.color}">${ing.abbr}</div>
        <div class="meta"><strong>${ing.name}</strong></div>
        <div><small>+10</small></div>`;
      div.addEventListener('click',()=>pour(ing.id,10));
      bottlesEl.appendChild(div);
    });

    RECIPES.forEach(r=>{
      const d=document.createElement('div');d.className='recipe';
      const list=Object.entries(r.mix).map(([k,v])=>`${k}:${v}`).join(', ');
      d.innerHTML=`<strong>${r.name}</strong><div style="font-size:13px;color:var(--muted)">${r.desc}</div><div style="margin-top:6px;font-size:12px">${list}</div>`;
      recipesEl.appendChild(d);
    });

    document.getElementById('undo').addEventListener('click',undo);
    document.getElementById('clear').addEventListener('click',clearGlass);
    document.getElementById('shake').addEventListener('click',()=>{state.shaken=true;stateEl.textContent='Agit√©';showReaction('Agit√© !');});
    document.getElementById('serve').addEventListener('click',serve);

    function pour(id,amount){
      if(state.pours.length>=3){showReaction('Max 3 ingr√©dients !');return;}
      state.pours.push({id,amount});
      state.volume+=Math.round(100/3);
      if(state.volume>100)state.volume=100;
      updateGlass();
      showReaction(`Ajout de ${id}`);
    }

    function undo(){
      const last=state.pours.pop();
      if(!last){showReaction('Rien √† annuler');return;}
      state.volume-=Math.round(100/3);
      if(state.volume<0)state.volume=0;
      updateGlass();
      showReaction(`Retir√© ${last.id}`);
    }

    function clearGlass(){
      state.pours=[];state.volume=0;state.shaken=false;
      updateGlass();showReaction('Chaudron vid√©');
      noctambuleEl.classList.remove("show");
    }

    function serve(){
      if(state.volume===0){showReaction('Vide !');return;}
      const s=summarizeState();
      const result=evaluate(s.composition);
      appendHistory(`${new Date().toLocaleTimeString()} ‚Äî ${result.text} ‚Äî ${s.summary}`);
      animateOutcome(result);
      gold+=Math.floor(result.score/10); // chaque potion rapporte de l'or
      goldEl.textContent=gold;
      state.pours=[];state.volume=0;state.shaken=false;
      setTimeout(updateGlass,800);
    }

    function summarizeState(){
      const map={};
      state.pours.forEach(p=>map[p.id]=(map[p.id]||0)+p.amount);
      const comp={};
      Object.keys(map).forEach(k=>comp[k]=Math.round(map[k]/(state.volume||1)*100));
      const parts=Object.entries(map).map(([k,v])=>`${k}:${v}`).join(', ');
      return {map,composition:comp,summary:parts||'vide'};
    }

    function evaluate(composition){
      const ids=Object.keys(composition);
      if(ids.includes('corbeau')&&ids.includes('paon')&&ids.includes('dragon')){
        noctambuleEl.classList.add("show");
        return {text:'Noctambule üóùÔ∏è',score:100};
      }
      if(JSON.stringify(composition)==='{}')return {text:'Inerte',score:0};
      const randomEffects=[
        'Vous flottez dans les airs !',
        'Vous coassez comme une grenouille.',
        'Vos yeux brillent dans le noir.',
        'Un √©ternuement de paillettes !',
        'Vous sentez un parfum de for√™t ancienne.'
      ];
      const effect=randomEffects[Math.floor(Math.random()*randomEffects.length)];
      return {text:effect,score:50+Math.random()*50};
    }

    function animateOutcome(score){
      const r=reactionEl;
      r.textContent=score.text;
      r.classList.add('show');
      garnishEl.textContent=score.text.includes('Noctambule')?'üåë':'‚ú®';
      setTimeout(()=>r.classList.remove('show'),1600);
    }

    function appendHistory(text){
      const d=document.createElement('div');
      d.style.padding='6px 4px';d.style.fontSize='13px';d.style.borderBottom='1px dashed rgba(255,255,255,0.02)';
      d.textContent=text;historyEl.prepend(d);
    }

    function updateGlass(){
      const h=Math.min(100,state.volume);
      liquidEl.style.height=h+'%';
      let r=0,g=0,b=0,total=0;
      state.pours.forEach(p=>{
        const ing=INGREDIENTS.find(i=>i.id===p.id);
        if(!ing)return;
        const col=hexToRgb(ing.color);if(!col)return;
        r+=col.r*p.amount;g+=col.g*p.amount;b+=col.b*p.amount;total+=p.amount;
      });
      if(total>0){r=Math.round(r/total);g=Math.round(g/total);b=Math.round(b/total);
        liquidEl.style.background=`linear-gradient(180deg,rgba(${r},${g},${b},0.95),rgba(${Math.max(0,r-30)},${Math.max(0,g-30)},${Math.max(0,b-30)},0.9))`;}
      else liquidEl.style.background='transparent';
      volumeEl.textContent=state.volume;
    }

    function showReaction(txt){
      reactionEl.textContent=txt;reactionEl.classList.add('show');
      setTimeout(()=>reactionEl.classList.remove('show'),900);
    }

    function hexToRgb(hex){
      if(!hex)return null;hex=hex.replace('#','');
      if(hex.length===3)hex=hex.split('').map(c=>c+c).join('');
      const num=parseInt(hex,16);
      return{r:(num>>16)&255,g:(num>>8)&255,b:num&255};
    }
  </script>
</body>
</html>
